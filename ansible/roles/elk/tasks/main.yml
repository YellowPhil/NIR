- name: "Update cache"
  #ansible.builtin.shell:
  #  cmd: sudo apt update
  apt:
    update_cache: true
    cache_valid_time: 86400

- name: Add Elasticsearch apt key.
  apt_key:
    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    state: present

- name: Add Elasticsearch repository.
  environment:
    http_proxy: "http://user:7eec5c51c76842170155cd1914b7cf54@:87.228.19.245:8080"
  apt_repository:
    repo: 'deb https://artifacts.elastic.co/packages/{{ elasticsearch_version }}/apt stable main'
    state: present
    update_cache: true
    validate_certs: false

- name: Install logstash
  environment:
    http_proxy: "http://user:7eec5c51c76842170155cd1914b7cf54@:87.228.19.245:8080"
  apt:
    name: logstash
    state: present
    allow_unauthenticated: true

- name: Install java
  apt:
    name: openjdk-11-jre
    state: present
    allow_unauthenticated: true

- name: Install elasticsearch
  environment:
    http_proxy: "http://user:7eec5c51c76842170155cd1914b7cf54@:87.228.19.245:8080"
  apt:
    name: elasticsearch
    state: present
    allow_unauthenticated: true

- name: Install kibana
  environment:
    http_proxy: "http://user:7eec5c51c76842170155cd1914b7cf54@:87.228.19.245:8080"
  apt:
    name: kibana
    state: present
    allow_unauthenticated: true

- name: copy kibana config
  copy:
    src: kibana.yml
    dest: /etc/kibana/kibana.yml
    owner: "root"
    group: "kibana"
    mode: 0660

- name: elasticsearch change start timeout to 3min
  lineinfile:
    destfile: /usr/lib/systemd/system/elasticsearch.service
    regexp: 'TimeoutStartSec='
    line: 'TimeoutStartSec=180'

- name: copy elasticsearch config
  copy:
    src: elasticsearch.yml
    dest: /etc/elasticsearch/elasticsearch.yml
    owner: "root"
    group: "elasticsearch"
    mode: 0660

- name: enable logstash
  service:
    name: logstash
    enabled: yes

- name: enable elasticsearch
  service:
    name: elasticsearch
    enabled: yes

- name: enable kibana
  service:
    name: kibana
    enabled: yes

- name: start logstash
  service:
    name: logstash
    state: started

- name: start elasticsearch
  service:
    name: elasticsearch
    state: started

- name: start kibana
  service:
    name: kibana
    state: started
